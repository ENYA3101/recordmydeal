<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3分K 狙擊手特訓日誌</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { background-color: #09090b; color: #d4d4d8; font-family: sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        // ⚠️ 升級：引入 Google 登入相關的工具
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD4ff7leN5p8ZChx8rOLbOxtDttjK6ouQM",
            authDomain: "recordmydeal.firebaseapp.com",
            projectId: "recordmydeal",
            storageBucket: "recordmydeal.firebasestorage.app",
            messagingSenderId: "491360204056",
            appId: "1:491360204056:web:874f67540edf08d2dc1a6d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 將升級後的工具掛載到 window
        window.firebaseTools = { auth, db, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, collection, onSnapshot, addDoc, deleteDoc, doc, query, orderBy };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const IconTarget = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-emerald-500"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>;
        const IconClock = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;
        const IconAlert = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="shrink-0 mt-0.5"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>;
        const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>;
        const IconX = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" x2="9" y1="9" y2="15"/><line x1="9" x2="15" y1="9" y2="15"/></svg>;
        const IconChart = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></svg>;
        const IconCheckCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-1"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
        const IconAlertSmall = () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-1"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
        const IconDownload = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-1"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>;
        const IconFilter = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-1"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>;
        const IconGoogle = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" className="mr-2"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>;
        const IconLogOut = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>;

        function App() {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true); // 新增：認證狀態載入中
            const [trades, setTrades] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showForm, setShowForm] = useState(false);
            const [firebaseReady, setFirebaseReady] = useState(false);
            const [nyTime, setNyTime] = useState('');
            const [selectedDateFilter, setSelectedDateFilter] = useState('all');

            const [formData, setFormData] = useState({
                date: new Date().toISOString().split('T')[0],
                time: '', instrument: 'MNQ', direction: '多 (Long)', setup: '',
                stopLoss: '', risk: '', pnl: '', followedRules: true, notes: ''
            });

            // 紐約時鐘
            useEffect(() => {
                const updateTime = () => {
                    const options = { timeZone: 'America/New_York', hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' };
                    setNyTime(new Intl.DateTimeFormat('zh-TW', options).format(new Date()));
                };
                updateTime();
                const timerId = setInterval(updateTime, 1000);
                return () => clearInterval(timerId);
            }, []);

            // 等待 Firebase 載入
            useEffect(() => {
                const checkFirebase = setInterval(() => {
                    if (window.firebaseTools) {
                        setFirebaseReady(true);
                        clearInterval(checkFirebase);
                    }
                }, 100);
                return () => clearInterval(checkFirebase);
            }, []);

            // 監聽登入狀態
            useEffect(() => {
                if (!firebaseReady) return;
                const { auth, onAuthStateChanged } = window.firebaseTools;

                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setAuthLoading(false); // 狀態確認完畢
                });
                return () => unsubscribe();
            }, [firebaseReady]);

            // ⚠️ 新增：執行 Google 登入
            const handleGoogleLogin = async () => {
                const { auth, GoogleAuthProvider, signInWithPopup } = window.firebaseTools;
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Login Error:", error);
                    alert("登入失敗，請確認你的網路或彈出視窗設定！\n" + error.message);
                }
            };

            // ⚠️ 新增：登出功能
            const handleLogout = async () => {
                const { auth, signOut } = window.firebaseTools;
                try {
                    await signOut(auth);
                    setTrades([]); // 登出時清空畫面資料
                } catch (error) {
                    console.error("Logout Error:", error);
                }
            };

            // 獲取資料庫資料 (只有登入後才會執行)
            useEffect(() => {
                if (!user || !firebaseReady) return;
                const { db, collection, query, orderBy, onSnapshot } = window.firebaseTools;

                const tradesRef = collection(db, 'users', user.uid, 'trades');
                const q = query(tradesRef, orderBy('createdAt', 'desc'));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedTrades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTrades(fetchedTrades);
                    setLoading(false);
                }, (error) => {
                    console.error("Firestore Error:", error);
                    alert("資料庫讀取失敗，如果你剛鎖上規則，請確保你有成功登入！");
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user, firebaseReady]);

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!user || !firebaseReady) return;
                const { db, collection, addDoc } = window.firebaseTools;

                try {
                    const tradesRef = collection(db, 'users', user.uid, 'trades');
                    await addDoc(tradesRef, {
                        ...formData,
                        stopLoss: Number(formData.stopLoss), risk: Number(formData.risk), pnl: Number(formData.pnl),
                        createdAt: new Date(`${formData.date}T${formData.time || '00:00'}`).toISOString()
                    });
                    setFormData(prev => ({ ...prev, time: '', setup: '', stopLoss: '', risk: '', pnl: '', followedRules: true, notes: '' }));
                    setShowForm(false);
                } catch (error) {
                    console.error("Error adding document: ", error);
                    alert("儲存失敗，請檢查資料庫權限設定。");
                }
            };

            const handleDelete = async (id) => {
                if (!user || !firebaseReady || !window.confirm('確定要刪除這筆紀錄嗎？')) return;
                const { db, doc, deleteDoc } = window.firebaseTools;
                try {
                    const docRef = doc(db, 'users', user.uid, 'trades', id);
                    await deleteDoc(docRef);
                } catch (error) {
                    console.error("Error deleting document: ", error);
                }
            };

            const exportToCSV = () => {
                if (trades.length === 0) return alert('沒有可以匯出的資料！');
                const headers = ['日期', '時間 (紐約)', '商品', '方向', '進場型態', '停損距離(點)', '風險($)', '實際盈虧($)', '遵守紀律', '覆盤筆記'];
                const csvRows = trades.map(t => {
                    const notesCleaned = `"${(t.notes || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`;
                    return [t.date, t.time, t.instrument, t.direction, `"${t.setup || ''}"`, t.stopLoss, t.risk, t.pnl, t.followedRules ? '是' : '否', notesCleaned].join(',');
                });
                const bom = '\uFEFF';
                const csvContent = bom + headers.join(',') + '\n' + csvRows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `特訓日誌_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const uniqueDates = useMemo(() => {
                const dates = [...new Set(trades.map(t => t.date))];
                return dates.sort((a, b) => new Date(b) - new Date(a));
            }, [trades]);

            const filteredTrades = useMemo(() => {
                if (selectedDateFilter === 'all') return trades;
                return trades.filter(t => t.date === selectedDateFilter);
            }, [trades, selectedDateFilter]);

            const groupedTrades = useMemo(() => {
                const groups = {};
                filteredTrades.forEach(trade => {
                    if (!groups[trade.date]) groups[trade.date] = [];
                    groups[trade.date].push(trade);
                });
                return groups;
            }, [filteredTrades]);

            const stats = {
                total: filteredTrades.length, wins: filteredTrades.filter(t => t.pnl > 0).length,
                losses: filteredTrades.filter(t => t.pnl <= 0).length, rulesFollowed: filteredTrades.filter(t => t.followedRules).length,
                totalPnl: filteredTrades.reduce((sum, t) => sum + (Number(t.pnl) || 0), 0)
            };

            const winRate = stats.total > 0 ? Math.round((stats.wins / stats.total) * 100) : 0;
            const disciplineRate = stats.total > 0 ? Math.round((stats.rulesFollowed / stats.total) * 100) : 0;

            // ⚠️ 狀態 1：系統載入中
            if (!firebaseReady || authLoading) {
                return <div className="min-h-screen bg-zinc-950 flex items-center justify-center text-emerald-500 font-bold">系統初始化中...</div>;
            }

            // ⚠️ 狀態 2：尚未登入，顯示精美的登入畫面
            if (!user) {
                return (
                    <div className="min-h-screen bg-zinc-950 flex flex-col items-center justify-center p-4">
                        <div className="bg-zinc-900 border border-zinc-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center space-y-6">
                            <div className="flex justify-center mb-2">
                                <div className="bg-emerald-500/10 p-4 rounded-full">
                                    <IconTarget />
                                </div>
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold text-zinc-100 mb-2">狙擊手特訓日誌</h1>
                                <p className="text-sm text-zinc-500">登入以同步並保護你的交易覆盤資料</p>
                            </div>
                            <button 
                                onClick={handleGoogleLogin}
                                className="w-full bg-white text-zinc-900 font-bold py-3 px-4 rounded-xl flex items-center justify-center hover:bg-zinc-200 transition-colors shadow-lg"
                            >
                                <IconGoogle />
                                使用 Google 帳號登入
                            </button>
                            <p className="text-xs text-zinc-600 mt-4">
                                * 資料庫已開啟最高安全防護，只有你能存取自己的紀錄。
                            </p>
                        </div>
                    </div>
                );
            }

            // ⚠️ 狀態 3：已登入，顯示主要應用程式
            return (
                <div className="min-h-screen bg-zinc-950 text-zinc-300 font-sans pb-20">
                    {/* 頂部導航 */}
                    <header className="bg-zinc-900 border-b border-zinc-800 p-4 sticky top-0 z-10 shadow-sm">
                        <div className="max-w-3xl mx-auto flex flex-col md:flex-row md:justify-between gap-3">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center gap-2">
                                    <IconTarget />
                                    <h1 className="text-xl font-bold text-zinc-100">3分K 狙擊手特訓</h1>
                                </div>
                                {/* 手機版才顯示在這裡的時鐘 */}
                                <div className="md:hidden text-xs font-mono text-emerald-400 flex items-center gap-1.5 bg-zinc-950 border border-zinc-800 px-2 py-1 rounded-lg">
                                    <IconClock /> NY: {nyTime || '--:--:--'}
                                </div>
                            </div>
                            
                            <div className="flex items-center justify-between md:justify-end gap-3">
                                {/* 電腦版時鐘 */}
                                <div className="hidden md:flex text-sm font-mono text-emerald-400 items-center gap-1.5 bg-zinc-950 border border-zinc-800 px-3 py-1.5 rounded-lg">
                                    <IconClock /> NY: {nyTime || '--:--:--'}
                                </div>
                                {/* 使用者資訊與登出按鈕 */}
                                <div className="flex items-center gap-2 bg-zinc-950 border border-zinc-800 rounded-lg pl-3 pr-1 py-1 text-xs">
                                    <span className="text-zinc-400 truncate max-w-[120px]">{user.email || '已登入'}</span>
                                    <button 
                                        onClick={handleLogout}
                                        className="bg-rose-500/10 text-rose-500 hover:bg-rose-500 hover:text-white p-1.5 rounded transition-colors flex items-center"
                                        title="登出"
                                    >
                                        <IconLogOut />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    {loading ? (
                        <div className="text-center py-20 text-emerald-500">載入交易紀錄中...</div>
                    ) : (
                        <main className="max-w-3xl mx-auto p-4 space-y-6">
                            {/* 篩選器 */}
                            {uniqueDates.length > 0 && (
                                <div className="flex justify-end mb-2">
                                    <div className="flex items-center bg-zinc-900 border border-zinc-800 rounded-lg overflow-hidden p-1 shadow-sm">
                                        <span className="text-zinc-500 pl-2 pr-1"><IconFilter /></span>
                                        <select 
                                            value={selectedDateFilter} 
                                            onChange={(e) => setSelectedDateFilter(e.target.value)}
                                            className="bg-transparent text-sm text-zinc-300 py-1.5 pr-3 pl-1 outline-none cursor-pointer"
                                        >
                                            <option value="all">總覽 (顯示所有日期)</option>
                                            {uniqueDates.map(date => (
                                                <option key={date} value={date}>{date} 檢討</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                            )}

                            {/* 統計儀表板 */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div className="bg-zinc-900 p-3 rounded-xl border border-zinc-800 shadow-sm flex flex-col items-center justify-center">
                                    <div className="text-zinc-500 text-xs mb-1">紀律遵守率</div>
                                    <div className={`text-2xl font-bold ${disciplineRate >= 80 ? 'text-emerald-500' : 'text-rose-500'}`}>{disciplineRate}%</div>
                                </div>
                                <div className="bg-zinc-900 p-3 rounded-xl border border-zinc-800 shadow-sm flex flex-col items-center justify-center">
                                    <div className="text-zinc-500 text-xs mb-1">交易次數</div>
                                    <div className="text-2xl font-bold text-zinc-100">{stats.total}</div>
                                </div>
                                <div className="bg-zinc-900 p-3 rounded-xl border border-zinc-800 shadow-sm flex flex-col items-center justify-center">
                                    <div className="text-zinc-500 text-xs mb-1">勝率</div>
                                    <div className="text-2xl font-bold text-blue-400">{winRate}%</div>
                                </div>
                                <div className="bg-zinc-900 p-3 rounded-xl border border-zinc-800 shadow-sm flex flex-col items-center justify-center">
                                    <div className="text-zinc-500 text-xs mb-1">{selectedDateFilter === 'all' ? '總損益' : '單日損益'}</div>
                                    <div className={`text-2xl font-bold ${stats.totalPnl >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>${stats.totalPnl.toFixed(2)}</div>
                                </div>
                            </div>

                            {disciplineRate < 100 && stats.total > 0 && (
                                <div className="bg-rose-950/30 border border-rose-900/50 text-rose-400 p-3 rounded-lg flex items-start gap-3 text-sm">
                                    <IconAlert />
                                    <p>警告：紀律遵守率未達 100%。獲利不是重點，<b>「完美執行紀律」才是唯一目標</b>。請檢討違規操作。</p>
                                </div>
                            )}

                            <button onClick={() => setShowForm(!showForm)} className="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-medium py-3 rounded-xl flex items-center justify-center gap-2 transition-colors shadow-lg">
                                {showForm ? <IconX /> : <IconPlus />}
                                {showForm ? '取消紀錄' : '新增特訓紀錄'}
                            </button>

                            {/* 表單 */}
                            {showForm && (
                                <form onSubmit={handleSubmit} className="bg-zinc-900 border border-zinc-800 rounded-xl p-4 md:p-6 space-y-4 shadow-xl">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs text-zinc-500 mb-1">日期</label>
                                            <input type="date" name="date" value={formData.date} onChange={handleChange} required className="w-full bg-zinc-950 border border-zinc-800 rounded-lg p-2 text-sm text-zinc-100 focus:outline-none focus:border-emerald-500" />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-zinc-500 mb-1">進場時間 (紐約時區)</label>
                                            <input type="time" name="time" value={formData.time} onChange={handleChange} required className="w-full bg-zinc-950 border border-zinc-800 rounded-lg p-2 text-sm text-zinc-100 focus:outline-none focus:border-emerald-500" />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs text-zinc-500 mb-1">商品</label>
                                            <select name="instrument" value={formData.instrument} onChange={handleChange} className="w-full bg-zinc-950 border border-zinc-800 rounded-lg p-2 text-sm text-zinc-100 focus:outline-none focus:border-emerald-500">
                                                <option value="MNQ">MNQ (微型那指)</option>
                                                <option value="MES">MES (微型標普)</option>
                                                <option value="NQ">NQ (小那指)</option>
                                                <option value="XAUUSD">黃金</option>
                                                <option value="FX">外匯</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs text-zinc-500 mb-1">方向</label>
                                            <select name="direction" value={formData.direction} onChange={handleChange} className="w-full bg-zinc-950 border border-zinc-800 rounded-lg p-2 text-sm text-zinc-100 focus:outline-none focus:border-emerald-500">
                                                <option value="多 (Long)">多 (Long)</option>
                                                <option value="空 (Short)">空 (Short)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs text-zinc-500 mb-1">進場型態 (如: 破底翻回踩 FVG)</label>
                                        <input type="text" name="setup" value={formData.setup} onChange={handleChange} required placeholder="請描述你看到的型態..." className="w-full bg-zinc-950 border border-zinc-800 rounded-lg p-2 text-sm text-zinc-100 focus:outline-none focus:border-emerald-500" />
                                    </div>
                                    <div className="grid grid-cols-3 gap-3 border-t border-zinc-800 pt-4 mt-2">
                                        <div>
                                            <label className="block text-xs text-zinc-500 mb-1">停損點數</label>
                                            <input type="number" step="0.1" name="stopLoss" value={formData.stopLoss} onChange={handleChange} required placeholder="ex: 15" className="w-full bg-zinc-950 border border-zinc-800 rounded-lg p-2 text-sm text-zinc-100 focus:outline-none focus:border-rose-500" />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-zinc-500 mb-1">風險 ($)</label>
                                            <input type="number" step="0.1" name="risk" value={formData.risk} onChange={handleChange} required placeholder="ex: 30" className="w-full bg-zinc-950 border border-zinc-800 rounded-lg p-2 text-sm text-zinc-100 focus:outline-none focus:border-rose-500" />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-zinc-500 mb-1">實際盈虧 ($)</label>
                                            <input type="number" step="0.1" name="pnl" value={formData.pnl} onChange={handleChange} required placeholder="ex: 60" className="w-full bg-zinc-950 border border-zinc-800 rounded-lg p-2 text-sm text-zinc-100 focus:outline-none focus:border-emerald-500" />
                                        </div>
                                    </div>
                                    <div className="bg-zinc-950 p-3 rounded-lg border border-zinc-800 flex items-start gap-3 mt-4">
                                        <div className="pt-1">
                                            <input type="checkbox" id="followedRules" name="followedRules" checked={formData.followedRules} onChange={handleChange} className="w-5 h-5 accent-emerald-500 rounded cursor-pointer" />
                                        </div>
                                        <div className="flex-1 cursor-pointer" onClick={() => setFormData(p => ({...p, followedRules: !p.followedRules}))}>
                                            <label className="text-sm font-medium text-zinc-100 block mb-1">我完全遵守了三大紀律</label>
                                            <p className="text-xs text-zinc-500">1. 在紐約時段進場 2. 停損在計畫範圍內 3. 確認 3分K 收盤才進場</p>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs text-zinc-500 mb-1">覆盤筆記與情緒狀態</label>
                                        <textarea name="notes" value={formData.notes} onChange={handleChange} required rows="3" placeholder="進場當下你的情緒如何？這筆單有什麼可以改進的地方？" className="w-full bg-zinc-950 border border-zinc-800 rounded-lg p-2 text-sm text-zinc-100 focus:outline-none focus:border-emerald-500 resize-none"></textarea>
                                    </div>
                                    <button type="submit" className="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-medium py-3 rounded-xl transition-colors mt-2">儲存紀錄</button>
                                </form>
                            )}

                            {/* 歷史清單 */}
                            <div className="space-y-6 mt-6">
                                <div className="flex justify-between items-center border-b border-zinc-800 pb-2">
                                    <h2 className="text-sm font-semibold text-zinc-400 flex items-center gap-2"><IconChart /> 歷史紀錄清單</h2>
                                    {trades.length > 0 && (
                                        <button onClick={exportToCSV} className="text-xs text-zinc-400 hover:text-emerald-400 flex items-center bg-zinc-900 border border-zinc-800 px-3 py-1.5 rounded-lg transition-colors">
                                            <IconDownload /> 匯出 CSV
                                        </button>
                                    )}
                                </div>

                                {Object.keys(groupedTrades).length === 0 ? (
                                    <div className="text-center text-zinc-600 py-10 bg-zinc-900/50 rounded-xl border border-zinc-800 border-dashed">
                                        尚無交易紀錄，今天開始你的狙擊手特訓吧！
                                    </div>
                                ) : (
                                    Object.keys(groupedTrades).map(date => (
                                        <div key={date} className="space-y-3">
                                            <div className="flex items-center gap-3">
                                                <div className="bg-zinc-800 text-zinc-300 text-xs font-bold px-3 py-1 rounded-full shadow-sm">{date}</div>
                                                <div className="h-px bg-zinc-800 flex-1"></div>
                                                <div className="text-xs text-zinc-500 font-mono">
                                                    當日: <span className={groupedTrades[date].reduce((sum, t) => sum + Number(t.pnl), 0) >= 0 ? 'text-emerald-500' : 'text-rose-500'}>
                                                        ${groupedTrades[date].reduce((sum, t) => sum + Number(t.pnl), 0).toFixed(2)}
                                                    </span>
                                                </div>
                                            </div>
                                            {groupedTrades[date].map(trade => (
                                                <div key={trade.id} className="bg-zinc-900 border border-zinc-800 rounded-xl p-4 shadow-sm relative overflow-hidden flex flex-col gap-3 ml-2 md:ml-4">
                                                    <div className={`absolute left-0 top-0 bottom-0 w-1 ${trade.followedRules ? 'bg-emerald-500' : 'bg-rose-500'}`}></div>
                                                    <div className="flex justify-between items-start pl-2">
                                                        <div className="flex items-center gap-2">
                                                            <span className={`text-xs font-bold px-2 py-0.5 rounded ${trade.direction.includes('多') ? 'bg-blue-500/20 text-blue-400' : 'bg-rose-500/20 text-rose-400'}`}>
                                                                {trade.instrument} {trade.direction}
                                                            </span>
                                                            <span className="text-xs text-zinc-500 font-mono">{trade.time} (NY)</span>
                                                        </div>
                                                        <div className={`font-bold ${Number(trade.pnl) >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>
                                                            {Number(trade.pnl) >= 0 ? '+' : ''}${trade.pnl}
                                                        </div>
                                                    </div>
                                                    <div className="pl-2 flex justify-between items-center bg-zinc-950/50 p-2 rounded border border-zinc-800/50">
                                                        <div className="text-sm font-medium text-zinc-300 truncate pr-2 flex-1">{trade.setup}</div>
                                                        <div className="flex items-center gap-1 shrink-0">
                                                            {trade.followedRules ? (
                                                                <span className="flex items-center text-xs text-emerald-500 bg-emerald-500/10 px-2 py-1 rounded"><IconCheckCircle /> 守紀律</span>
                                                            ) : (
                                                                <span className="flex items-center text-xs text-rose-500 bg-rose-500/10 px-2 py-1 rounded"><IconAlertSmall /> 違規</span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div className="pl-2 grid grid-cols-1 md:grid-cols-4 gap-3">
                                                        <div className="md:col-span-3 text-sm text-zinc-400 italic bg-zinc-950/30 p-2.5 rounded">"{trade.notes}"</div>
                                                        <div className="flex md:flex-col justify-between items-end md:items-end gap-1 text-xs text-zinc-500">
                                                            <div className="flex items-center gap-3 md:gap-1 md:flex-col md:items-end font-mono">
                                                                <span>停損: {trade.stopLoss} 點</span>
                                                                <span>風險: ${trade.risk}</span>
                                                            </div>
                                                            <button onClick={() => handleDelete(trade.id)} className="text-zinc-600 hover:text-rose-400 transition-colors p-1"><IconTrash /></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ))
                                )}
                            </div>
                        </main>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


