import React, { useState, useEffect } from 'react';
import { Target, AlertTriangle, CheckCircle, XCircle, Trash2, Plus, BarChart2, Clock } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, query, orderBy } from 'firebase/firestore';

// ==========================================
// ⚠️ 關鍵修改區：請貼上你自己的 Firebase Config
// ==========================================

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyD4ff7leN5p8ZChx8rOLbOxtDttjK6ouQM",
  authDomain: "recordmydeal.firebaseapp.com",
  projectId: "recordmydeal",
  storageBucket: "recordmydeal.firebasestorage.app",
  messagingSenderId: "491360204056",
  appId: "1:491360204056:web:874f67540edf08d2dc1a6d"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

export default function App() {
  const [user, setUser] = useState(null);
  const [trades, setTrades] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showForm, setShowForm] = useState(false);

  const [formData, setFormData] = useState({
    date: new Date().toISOString().split('T')[0],
    time: '',
    instrument: 'MNQ',
    direction: '多 (Long)',
    setup: '',
    stopLoss: '',
    risk: '',
    pnl: '',
    followedRules: true,
    notes: ''
  });

  // 1. 初始化匿名登入
  useEffect(() => {
    signInAnonymously(auth).catch(error => {
      console.error("Auth Error:", error);
    });

    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
    });
    return () => unsubscribe();
  }, []);

  // 2. 獲取資料 (使用簡化的專屬路徑)
  useEffect(() => {
    if (!user) return;

    // 路徑簡化為： users / {你的UID} / trades
    const tradesRef = collection(db, 'users', user.uid, 'trades');
    // 使用 Firebase 原生的排序功能
    const q = query(tradesRef, orderBy('createdAt', 'desc'));
    
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const fetchedTrades = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setTrades(fetchedTrades);
      setLoading(false);
    }, (error) => {
      console.error("Firestore Error:", error);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [user]);

  const handleChange = (e) => {
    const { name, value, type, checked } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: type === 'checkbox' ? checked : value
    }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!user) return;

    try {
      const tradesRef = collection(db, 'users', user.uid, 'trades');
      await addDoc(tradesRef, {
        ...formData,
        stopLoss: Number(formData.stopLoss),
        risk: Number(formData.risk),
        pnl: Number(formData.pnl),
        // 儲存完整時間戳記以供排序
        createdAt: new Date(`${formData.date}T${formData.time || '00:00'}`).toISOString()
      });
      
      setFormData(prev => ({
        ...prev,
        time: '',
        setup: '',
        stopLoss: '',
        risk: '',
        pnl: '',
        followedRules: true,
        notes: ''
      }));
      setShowForm(false);
    } catch (error) {
      console.error("Error adding document: ", error);
      alert("儲存失敗，請檢查資料庫權限設定。");
    }
  };

  const handleDelete = async (id) => {
    if (!user || !window.confirm('確定要刪除這筆紀錄嗎？')) return;
    try {
      const docRef = doc(db, 'users', user.uid, 'trades', id);
      await deleteDoc(docRef);
    } catch (error) {
      console.error("Error deleting document: ", error);
    }
  };

  const stats = {
    total: trades.length,
    wins: trades.filter(t => t.pnl > 0).length,
    losses: trades.filter(t => t.pnl <= 0).length,
    rulesFollowed: trades.filter(t => t.followedRules).length,
    totalPnl: trades.reduce((sum, t) => sum + (Number(t.pnl) || 0), 0)
  };

  const winRate = stats.total > 0 ? Math.round((stats.wins / stats.total) * 100) : 0;
  const disciplineRate = stats.total > 0 ? Math.round((stats.rulesFollowed / stats.total) * 100) : 0;

  if (loading) {
    return <div className="min-h-screen bg-zinc-950 flex items-center justify-center text-emerald-500">載入中...</div>;
  }

  // ... (下方的 return JSX 介面部分完全不變，保留原樣) ...
  return (
    <div className="min-h-screen bg-zinc-950 text-zinc-300 font-sans pb-20">
      {/* 頂部導航 / 標題 */}
      <header className="bg-zinc-900 border-b border-zinc-800 p-4 sticky top-0 z-10">
        <div className="max-w-3xl mx-auto flex justify-between items-center">
          <div className="flex items-center gap-2">
            <Target className="w-6 h-6 text-emerald-500" />
            <h1 className="text-xl font-bold text-zinc-100">3分K 狙擊手特訓日誌</h1>
          </div>
          <div className="text-xs text-zinc-500 flex items-center gap-1 bg-zinc-800 px-2 py-1 rounded">
            <Clock className="w-3 h-3" />
            限定紐約時區
          </div>
        </div>
      </header>

      <main className="max-w-3xl mx-auto p-4 space-y-6">
        
        {/* 統計儀表板 */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div className="bg-zinc-900 p-3 rounded-xl border border-zinc-800 shadow-sm flex flex-col items-center justify-center">
            <div className="text-zinc-500 text-xs mb-1">紀律遵守率</div>
            <div className={`text-2xl font-bold ${disciplineRate >= 80 ? 'text-emerald-500' : 'text-rose-500'}`}>
              {disciplineRate}%
            </div>
          </div>
          <div className="bg-zinc-900 p-3 rounded-xl border border-zinc-800 shadow-sm flex flex-col items-center justify-center">
            <div className="text-zinc-500 text-xs mb-1">總交易次數</div>
            <div className="text-2xl font-bold text-zinc-100">{stats.total}</div>
          </div>
          <div className="bg-zinc-900 p-3 rounded-xl border border-zinc-800 shadow-sm flex flex-col items-center justify-center">
            <div className="text-zinc-500 text-xs mb-1">勝率</div>
            <div className="text-2xl font-bold text-blue-400">{winRate}%</div>
          </div>
          <div className="bg-zinc-900 p-3 rounded-xl border border-zinc-800 shadow-sm flex flex-col items-center justify-center">
            <div className="text-zinc-500 text-xs mb-1">總損益 (模擬)</div>
            <div className={`text-2xl font-bold ${stats.totalPnl >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>
              ${stats.totalPnl.toFixed(2)}
            </div>
          </div>
        </div>

        {/* 警告標語 */}
        {disciplineRate < 100 && stats.total > 0 && (
          <div className="bg-rose-950/30 border border-rose-900/50 text-rose-400 p-3 rounded-lg flex items-start gap-3 text-sm">
            <AlertTriangle className="w-5 h-5 shrink-0 mt-0.5" />
            <p>警告：你的紀律遵守率未達 100%。在特訓期間，獲利不是重點，<b>「完美執行紀律」才是唯一的目標</b>。請嚴格檢討違規的交易。</p>
          </div>
        )}

        {/* 新增紀錄按鈕 (Mobile 浮動按鈕或常規按鈕) */}
        <button 
          onClick={() => setShowForm(!showForm)}
          className="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-medium py-3 rounded-xl flex items-center justify-center gap-2 transition-colors shadow-lg"
        >
          {showForm ? <XCircle className="w-5 h-5" /> : <Plus className="w-5 h-5" />}
          {showForm ? '取消紀錄' : '新增特訓紀錄'}
        </button>

        {/* 表單區塊 */}
        {showForm && (
          <form onSubmit={handleSubmit} className="bg-zinc-900 border border-zinc-800 rounded-xl p-4 md:p-6 space-y-4 shadow-xl animate-in fade-in slide-in-from-top-4">
            
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-xs text-zinc-500 mb-1">日期</label>
                <input type="date" name="date" value={formData.date} onChange={handleChange} required className="w-full bg-zinc-950 border border-zinc-800 rounded-lg p-2 text-sm text-zinc-100 focus:outline-none focus:border-emerald-500" />
              </div>
              <div>
                <label className="block text-xs text-zinc-500 mb-1">進場時間 (紐約時區)</label>
                <input type="time" name="time" value={formData.time} onChange={handleChange} required className="w-full bg-zinc-950 border border-zinc-800 rounded-lg p-2 text-sm text-zinc-100 focus:outline-none focus:border-emerald-500" />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-xs text-zinc-500 mb-1">商品</label>
                <select name="instrument" value={formData.instrument} onChange={handleChange} className="w-full bg-zinc-950 border border-zinc-800 rounded-lg p-2 text-sm text-zinc-100 focus:outline-none focus:border-emerald-500">
                  <option value="MNQ">MNQ (微型那指)</option>
                  <option value="MES">MES (微型標普)</option>
                  <option value="NQ">NQ (小那指)</option>
                  <option value="XAUUSD">黃金</option>
                  <option value="FX">外匯</option>
                </select>
              </div>
              <div>
                <label className="block text-xs text-zinc-500 mb-1">方向</label>
                <select name="direction" value={formData.direction} onChange={handleChange} className="w-full bg-zinc-950 border border-zinc-800 rounded-lg p-2 text-sm text-zinc-100 focus:outline-none focus:border-emerald-500">
                  <option value="多 (Long)">多 (Long)</option>
                  <option value="空 (Short)">空 (Short)</option>
                </select>
              </div>
            </div>

            <div>
              <label className="block text-xs text-zinc-500 mb-1">進場型態 (如: 破底翻回踩 FVG)</label>
              <input type="text" name="setup" value={formData.setup} onChange={handleChange} required placeholder="請描述你看到的型態..." className="w-full bg-zinc-950 border border-zinc-800 rounded-lg p-2 text-sm text-zinc-100 focus:outline-none focus:border-emerald-500" />
            </div>

            <div className="grid grid-cols-3 gap-3 border-t border-zinc-800 pt-4 mt-2">
              <div>
                <label className="block text-xs text-zinc-500 mb-1">停損點數</label>
                <input type="number" step="0.1" name="stopLoss" value={formData.stopLoss} onChange={handleChange} required placeholder="ex: 15" className="w-full bg-zinc-950 border border-zinc-800 rounded-lg p-2 text-sm text-zinc-100 focus:outline-none focus:border-rose-500" />
              </div>
              <div>
                <label className="block text-xs text-zinc-500 mb-1">承擔風險 ($)</label>
                <input type="number" step="0.1" name="risk" value={formData.risk} onChange={handleChange} required placeholder="ex: 30" className="w-full bg-zinc-950 border border-zinc-800 rounded-lg p-2 text-sm text-zinc-100 focus:outline-none focus:border-rose-500" />
              </div>
              <div>
                <label className="block text-xs text-zinc-500 mb-1">實際盈虧 ($)</label>
                <input type="number" step="0.1" name="pnl" value={formData.pnl} onChange={handleChange} required placeholder="ex: 60" className="w-full bg-zinc-950 border border-zinc-800 rounded-lg p-2 text-sm text-zinc-100 focus:outline-none focus:border-emerald-500" />
              </div>
            </div>

            <div className="bg-zinc-950 p-3 rounded-lg border border-zinc-800 flex items-start gap-3 mt-4">
              <div className="pt-1">
                <input 
                  type="checkbox" 
                  id="followedRules" 
                  name="followedRules" 
                  checked={formData.followedRules} 
                  onChange={handleChange}
                  className="w-5 h-5 accent-emerald-500 rounded cursor-pointer"
                />
              </div>
              <div className="flex-1 cursor-pointer" onClick={() => setFormData(p => ({...p, followedRules: !p.followedRules}))}>
                <label className="text-sm font-medium text-zinc-100 block mb-1">我完全遵守了三大紀律</label>
                <p className="text-xs text-zinc-500">1. 在紐約時段進場 2. 停損在計畫範圍內 3. 確認 3分K 收盤才進場</p>
              </div>
            </div>

            <div>
              <label className="block text-xs text-zinc-500 mb-1">覆盤筆記與情緒狀態</label>
              <textarea name="notes" value={formData.notes} onChange={handleChange} required rows="3" placeholder="進場當下你的情緒如何？這筆單有什麼可以改進的地方？" className="w-full bg-zinc-950 border border-zinc-800 rounded-lg p-2 text-sm text-zinc-100 focus:outline-none focus:border-emerald-500 resize-none"></textarea>
            </div>

            <button type="submit" className="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-medium py-3 rounded-xl transition-colors mt-2">
              儲存紀錄
            </button>
          </form>
        )}

        {/* 歷史紀錄列表 */}
        <div className="space-y-3 mt-6">
          <h2 className="text-sm font-semibold text-zinc-400 flex items-center gap-2 mb-4">
            <BarChart2 className="w-4 h-4" /> 最近特訓紀錄
          </h2>
          
          {trades.length === 0 ? (
            <div className="text-center text-zinc-600 py-10 bg-zinc-900/50 rounded-xl border border-zinc-800 border-dashed">
              尚無交易紀錄，今天開始你的狙擊手特訓吧！
            </div>
          ) : (
            trades.map(trade => (
              <div key={trade.id} className="bg-zinc-900 border border-zinc-800 rounded-xl p-4 shadow-sm relative overflow-hidden flex flex-col gap-3">
                {/* 紀律標籤邊線 */}
                <div className={`absolute left-0 top-0 bottom-0 w-1 ${trade.followedRules ? 'bg-emerald-500' : 'bg-rose-500'}`}></div>
                
                {/* 頭部資訊 */}
                <div className="flex justify-between items-start pl-2">
                  <div className="flex items-center gap-2">
                    <span className={`text-xs font-bold px-2 py-0.5 rounded ${trade.direction.includes('多') ? 'bg-blue-500/20 text-blue-400' : 'bg-rose-500/20 text-rose-400'}`}>
                      {trade.instrument} {trade.direction}
                    </span>
                    <span className="text-xs text-zinc-500">{trade.date} {trade.time} (NY)</span>
                  </div>
                  <div className={`font-bold ${Number(trade.pnl) >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>
                    {Number(trade.pnl) >= 0 ? '+' : ''}${trade.pnl}
                  </div>
                </div>

                {/* 型態與紀律 */}
                <div className="pl-2 flex justify-between items-center bg-zinc-950/50 p-2 rounded">
                  <div className="text-sm font-medium text-zinc-300 truncate pr-2 flex-1">
                    {trade.setup}
                  </div>
                  <div className="flex items-center gap-1 shrink-0">
                    {trade.followedRules ? (
                      <span className="flex items-center text-xs text-emerald-500 bg-emerald-500/10 px-2 py-1 rounded"><CheckCircle className="w-3 h-3 mr-1"/> 遵守紀律</span>
                    ) : (
                      <span className="flex items-center text-xs text-rose-500 bg-rose-500/10 px-2 py-1 rounded"><AlertTriangle className="w-3 h-3 mr-1"/> 違規操作</span>
                    )}
                  </div>
                </div>

                {/* 筆記與數值 */}
                <div className="pl-2 grid grid-cols-1 md:grid-cols-4 gap-3">
                  <div className="md:col-span-3 text-sm text-zinc-400 italic bg-zinc-950/30 p-2 rounded border border-zinc-800/50">
                    "{trade.notes}"
                  </div>
                  <div className="flex md:flex-col justify-between items-end md:items-end gap-1 text-xs text-zinc-500">
                    <div className="flex items-center gap-2 md:gap-0 md:flex-col md:items-end">
                      <span>停損距離: {trade.stopLoss} 點</span>
                      <span>承擔風險: ${trade.risk}</span>
                    </div>
                    <button onClick={() => handleDelete(trade.id)} className="text-zinc-600 hover:text-rose-400 transition-colors p-1">
                      <Trash2 className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              </div>
            ))
          )}
        </div>
      </main>
    </div>
  );
}


